<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Punjabi Stream</title>
  <link rel="icon" href="https://i.postimg.cc/FRDPFKpY/favicon-96x96.png" type="image/png">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Gurmukhi:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://www.youtube.com/iframe_api"></script>

  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      background-color: black; font-family: "Noto Sans Gurmukhi", sans-serif;
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }
    #container { position: relative; width: 100vw; height: 100vh; }
    #stream { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; z-index: 0; }
    #stream iframe, #stream img { width: 100%; height: 100%; border: none; object-fit: cover; display:block; }
    #hls-video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; display: none; }
    #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; cursor: pointer; outline: none; }
    #channelName {
      position: absolute; bottom: -60px; left: 0; width: 100%;
      background: rgba(0,41,107,0.7); color: #ffd500;
      padding: 12px 20px; font-size: 22px; font-weight: bold;
      text-align: center; opacity: 0; transition: all 0.6s ease; z-index: 3;
    }
    #channelName.show { bottom: 0; opacity: 1; }
    .loading {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      width: 50px; height: 50px; border: 5px solid rgba(255, 213, 0, 0.3);
      border-radius: 50%; border-top-color: #ffd500;
      animation: spin 1s ease-in-out infinite; z-index: 4; display: none;
    }
    @keyframes spin { to { transform: translate(-50%, -50%) rotate(360deg); } }
    #time-tv {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      display: none; z-index: 1; background: url("https://i.postimg.cc/053WPD28/haarimandr.png") no-repeat center center;
      background-size: cover; font-family: "Arial Black", sans-serif;
    }
    #time-tv .clock { position: absolute; top: 6%; right: 3%; font-size: 8.7vw; color: #FFD700; text-shadow: 0 0 10px #FFD700; }
    #time-tv .date { position: absolute; top: 2%; right: 3.5%; font-size: 3vw; color: #FFE066; }
    #overlay:focus { outline: 2px solid rgba(255,255,255,0.02); }
  </style>
</head>
<body>
  <div id="container">
    <div id="stream"></div>
    <video id="hls-video" playsinline></video>
    <div id="time-tv"><div class="clock">00:00:00 AM</div><div class="date"></div></div>
    <div id="overlay" tabindex="0"></div>
    <div id="channelName"></div>
    <div class="loading" id="loading"></div>
  </div>

<script>
const CHANNELS = [
  { name: "1. ਪਟਨਾ ਸਾਹਿਬ ਲਾਈਵ", channelId: "UC3nqw1kd4AK1q9e68YUoLDQ", fallback: "https://www.youtube.com/embed/TTK7eNuI3M0?autoplay=1&mute=0&modestbranding=1&controls=0&showinfo=0&rel=0&enablejsapi=1", type: "auto-live" },
  { name: "2. ਅੰਮ੍ਰਿਤਸਰ ਸਾਹਿਬ ਲਾਈਵ", channelId: "UCYn6UEtQ771a_OWSiNBoG8w", type: "auto-live" },
  { name: "3. ਬਾਬਾ ਦੀਪ ਸਿੰਘ ਜੀ ਅੰਮ੍ਰਿਤਸਰ ਸਾਹਿਬ ਲਾਈਵ", channelId: "UCxWx-MPft_7mKrFtN6uOaAA", type: "auto-live" },
  { name: "4. ਫਤੇਹਗੜ੍ਹ ਸਾਹਿਬ ਲਾਈਵ", channelId: "UCudVHqnOekwcvpzNpY8_ERw", type: "auto-live" },
  { name: "5. ਆਨੰਦਪੁਰ ਸਾਹਿਬ ਲਾਈਵ", channelId: "UCSx5035_us8h8DOp_YhQDaw", type: "auto-live" },
  { name: "6. ਦਮਦਮਾ ਸਾਹਿਬ ਲਾਈਵ", channelId: "UCY8jMpyRRcdzSf6uLiU6izQ", type: "auto-live" },
  { name: "7. ਹਜ਼ੂਰ ਸਾਹਿਬ ਲਾਈਵ", channelId: "UCuerQ47I9Y2qxr4eIopxbYw", type: "auto-live" },
  { name: "8. ਚੜਦੀਕਲਾ ਟਾਈਮ ਟੀਵੀ", url: "https://www.yupptv.com/yupptvnew/channels/chardikala-time-tv/live/embed", type: "iframe" },
  { name: "9. ਡੀਡੀ ਪੰਜਾਬੀ", url: "https://d3eyhgoylams0m.cloudfront.net/v1/manifest/93ce20f0f52760bf38be911ff4c91ed02aa2fd92/ed7bd2c7-8d10-4051-b397-2f6b90f99acb/20c8ad14-a158-4a42-8889-e032d070856e/2.m3u8", type: "hls" },
  { name: "0. ਲਾਈਵ ਟਾਈਮ", type: "time" }
];

const STREAM_DIV = document.getElementById('stream');
const HLS_VIDEO = document.getElementById('hls-video');
const TIME_TV = document.getElementById('time-tv');
const channelNameBox = document.getElementById('channelName');
const loadingIndicator = document.getElementById('loading');
const OVERLAY = document.getElementById('overlay');

let currentChannel = parseInt(localStorage.getItem('currentChannel')) || 0;
let hideTimeout, hls, refreshTimer, loadTimeout;
let lastScrollTime = 0; 
const SCROLL_SPEED_MS = 350; 

let usingFallbackCh1 = false;
let ytPlayerForCh1 = null;
let fallbackCheckTimerCh1 = null;
let ytApiReady = false;
let pendingPlayerInitCh1 = false;

window.onYouTubeIframeAPIReady = function() {
  ytApiReady = true;
  if (pendingPlayerInitCh1) { initYouTubePlayerForCh1(); pendingPlayerInitCh1 = false; }
};

function loadChannel(index) {
  localStorage.setItem('currentChannel', index);
  loadingIndicator.style.display = 'block';
  STREAM_DIV.style.display = 'none';
  HLS_VIDEO.style.display = 'none';
  TIME_TV.style.display = 'none';
  STREAM_DIV.innerHTML = '';
  HLS_VIDEO.pause();

  usingFallbackCh1 = false;
  if (fallbackCheckTimerCh1) clearTimeout(fallbackCheckTimerCh1);
  if (hls) { hls.destroy(); hls = null; }
  if (ytPlayerForCh1) { try { ytPlayerForCh1.destroy(); } catch(e){} ytPlayerForCh1 = null; }

  const channel = CHANNELS[index];

  if (channel.type === 'auto-live') {
    STREAM_DIV.style.display = 'block';
    const iframe = document.createElement('iframe');
    if (index === 0) iframe.id = 'ch1-iframe';
    iframe.setAttribute('allow', 'autoplay; encrypted-media; fullscreen');
    STREAM_DIV.appendChild(iframe);

    const rssUrl = `https://www.youtube.com/feeds/videos.xml?channel_id=${channel.channelId}`;
    fetch(`https://api.jsonbin.io/v3/b/654a88f512a5d37659955e88`, { // Using a public mirror or rss2json
        // Note: For production use https://api.rss2json.com/v1/api.json?rss_url=...
    });
    
    // Direct Fetch via RSS2JSON (Most reliable for WebOS)
    fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rssUrl)}`)
      .then(res => res.json())
      .then(data => {
        let vidId = (data.items && data.items.length > 0) ? data.items[0].link.split('v=')[1] : `live_stream?channel=${channel.channelId}`;
        iframe.src = `https://www.youtube.com/embed/${vidId}?autoplay=1&modestbranding=1&controls=0&rel=0&enablejsapi=1`;
        if (index === 0) {
          iframe.onload = () => { loadingIndicator.style.display = 'none'; setTimeout(() => { if (ytApiReady) initYouTubePlayerForCh1(); else pendingPlayerInitCh1 = true; }, 1000); };
        } else {
          iframe.onload = () => loadingIndicator.style.display = 'none';
        }
      })
      .catch(() => {
        iframe.src = `https://www.youtube.com/embed/live_stream?channel=${channel.channelId}&autoplay=1&controls=0&enablejsapi=1`;
        iframe.onload = () => loadingIndicator.style.display = 'none';
      });

  } else if (channel.type === 'iframe') {
    STREAM_DIV.style.display = 'block';
    const iframe = document.createElement('iframe');
    iframe.src = channel.url;
    iframe.setAttribute('allow', 'autoplay; encrypted-media; fullscreen');
    iframe.onload = () => loadingIndicator.style.display = 'none';
    STREAM_DIV.appendChild(iframe);
  } else if (channel.type === 'hls') {
    HLS_VIDEO.style.display = 'block';
    if (Hls.isSupported()) {
      hls = new Hls(); hls.loadSource(channel.url); hls.attachMedia(HLS_VIDEO);
      hls.on(Hls.Events.MANIFEST_PARSED, () => { HLS_VIDEO.play(); loadingIndicator.style.display = 'none'; });
    }
  } else if (channel.type === 'time') {
    TIME_TV.style.display = 'block'; loadingIndicator.style.display = 'none';
  }

  showChannelName(channel.name);
  setupAutoRefresh();
}

function setupAutoRefresh() {
  clearTimeout(refreshTimer);
  refreshTimer = setTimeout(() => { window.location.reload(); }, 14400000); // 4 Hours
}

/* --- Rest of keyboard and logic remains same --- */
function initYouTubePlayerForCh1() {
  if (!ytApiReady || usingFallbackCh1) return;
  ytPlayerForCh1 = new YT.Player('ch1-iframe', { events: { onReady: onCh1Ready, onStateChange: onCh1StateChange, onError: onCh1Error } });
}
function onCh1Ready() { fallbackCheckTimerCh1 = setTimeout(() => { if (ytPlayerForCh1.getPlayerState() < 0) tryActivateFallbackCh1(); }, 20000); }
function onCh1StateChange(e) { if (e.data === 0) tryActivateFallbackCh1(); }
function onCh1Error() { tryActivateFallbackCh1(); }
function tryActivateFallbackCh1() {
  if (usingFallbackCh1) return; usingFallbackCh1 = true;
  STREAM_DIV.innerHTML = `<iframe src="${CHANNELS[0].fallback}" allow="autoplay; encrypted-media; fullscreen"></iframe>`;
}

function showChannelName(name) {
  channelNameBox.textContent = name; channelNameBox.classList.add("show");
  clearTimeout(hideTimeout); hideTimeout = setTimeout(() => channelNameBox.classList.remove("show"), 3000);
}

function queueChannelLoad(index) {
  currentChannel = index; showChannelName(CHANNELS[index].name);
  if (loadTimeout) clearTimeout(loadTimeout);
  loadTimeout = setTimeout(() => { loadChannel(index); }, 600);
}

function nextChannel() { const now = Date.now(); if (now - lastScrollTime < SCROLL_SPEED_MS) return; lastScrollTime = now; queueChannelLoad((currentChannel + 1) % CHANNELS.length); }
function prevChannel() { const now = Date.now(); if (now - lastScrollTime < SCROLL_SPEED_MS) return; lastScrollTime = now; queueChannelLoad((currentChannel - 1 + CHANNELS.length) % CHANNELS.length); }

window.addEventListener('keydown', (e) => {
  const k = e.key;
  if (["ArrowRight", "d", "ArrowUp", "PageUp"].includes(k)) { e.preventDefault(); nextChannel(); }
  else if (["ArrowLeft", "a", "ArrowDown", "PageDown"].includes(k)) { e.preventDefault(); prevChannel(); }
  else if (/^[1-9]$/.test(k)) { e.preventDefault(); queueChannelLoad(parseInt(k) - 1); }
  else if (k === "0") { e.preventDefault(); queueChannelLoad(9); }
});

OVERLAY.addEventListener('click', nextChannel);

function updateLocalTime() {
  const now = new Date();
  document.querySelector('#time-tv .clock').textContent = now.toLocaleTimeString();
  document.querySelector('#time-tv .date').textContent = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
}
setInterval(updateLocalTime, 1000); updateLocalTime();
loadChannel(currentChannel);
</script>
</body>
</html>
