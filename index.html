<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Gurbani Stream</title>
  
  <link rel="preconnect" href="https://www.youtube.com">
  <link rel="preconnect" href="https://www.google.com">
  <link rel="preconnect" href="https://api.rss2json.com">
  <link rel="dns-prefetch" href="https://www.youtube.com">
  <link rel="dns-prefetch" href="https://api.rss2json.com">

  <link rel="icon" href="favicon.png" type="image/png">
  
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Gurmukhi:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://www.youtube.com/iframe_api"></script>

  <style>
    html, body {
      margin: 0; 
      padding: 0; 
      height: 100%;
      background-color: black; 
      font-family: "Noto Sans Gurmukhi", sans-serif;
      overflow: hidden; 
      -webkit-tap-highlight-color: transparent; 
      user-select: none;
      cursor: none;
    }
    body.user-active { 
      cursor: default; 
    }
    
    #container { 
      position: relative; 
      width: 100vw; 
      height: 100vh; 
    }

    #stream { 
      position: absolute; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      z-index: 0; 
    }

    .video-placeholder { 
      width: 100%; 
      height: 100%; 
      background: black; 
    }
    
    #hls-video { 
      position: absolute; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      object-fit: cover; 
      z-index: 1; 
      display: none; 
    }

    /* --- BACKGROUND IMAGE FOR CH 2 AUDIO MODE --- */
    #audio-bg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-position: center;
      background-size: cover;
      background-repeat: no-repeat;
      z-index: 1; 
      display: none;
    }

    #overlay { 
      position: absolute; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      z-index: 2; 
      cursor: pointer; 
      outline: none; 
    }

    /* --- TOGGLE BUTTON STYLES (UPDATED: TOP LEFT) --- */
    #toggleBtn {
      position: absolute;
      top: 25px;
      left: 25px; /* Moved to Left */
      width: 25px;
      height: 25px;
      border-radius: 25%;
      display: none; 
      justify-content: center;
      align-items: center;
      font-size: 12px;
      font-family: Arial, sans-serif;
      font-weight: bold;
      z-index: 10; 
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.6);
      border: 2px solid rgba(255, 255, 255, 0.2);
      transition: transform 0.2s ease;
    }
    #toggleBtn:active {
      transform: scale(0.9);
    }
    /* State A: Gold Text, Blue Back */
    .toggle-A { 
      background-color: #00296B; 
      color: #FFD700; 
    }
    /* State B: Blue Text, Gold Back */
    .toggle-B { 
      background-color: #FFD700; 
      color: #00296B; 
    }
    
    #channelName {
      position: absolute; 
      bottom: -80px; 
      left: 0; 
      width: 100%;
      padding: 15px 20px; 
      font-size: 24px; 
      font-weight: bold;
      text-align: center; 
      opacity: 0; 
      transition: all 0.6s ease; 
      z-index: 3;
    }
    .style-main { 
      background-color: rgba(0, 41, 107, 0.9) !important; 
      color: #FFD700 !important; 
    }
    .style-alt { 
      background-color: #FFD700 !important; 
      color: #00296B !important; 
    }
    #channelName.show { 
      bottom: 0; 
      opacity: 1; 
    }
    
    .loading {
      position: absolute; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%);
      width: 60px; 
      height: 60px; 
      border: 6px solid rgba(255, 213, 0, 0.2);
      border-radius: 50%; 
      border-top-color: #ffd500;
      animation: spin 1s linear infinite; 
      z-index: 4; 
      display: none;
    }
    @keyframes spin { 
      to { transform: translate(-50%, -50%) rotate(360deg); } 
    }
    
    #time-tv {
      position: absolute; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%;
      display: none; 
      z-index: 1; 
      background: url("haarimandr.png") no-repeat center center;
      background-size: cover; 
      font-family: "Arial Black", sans-serif;
    }
    #time-tv .clock { 
      position: absolute; 
      top: 6%; 
      right: 3%; 
      font-size: 8.7vw; 
      color: #FFD700; 
      text-shadow: 0 0 10px #FFD700; 
    }
    #time-tv .date { 
      position: absolute; 
      top: 2%; 
      right: 3.5%; 
      font-size: 3vw; 
      color: #FFE066; 
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="stream"></div>
    <video id="hls-video" playsinline></video>
    
    <audio id="bg-audio" preload="auto"></audio>
    
    <div id="audio-bg"></div>
    
    <div id="time-tv"><div class="clock"></div><div class="date"></div></div>
    
    <div id="toggleBtn" class="toggle-A">A</div>
    
    <div id="overlay" tabindex="0"></div>
    <div id="channelName" class="style-main"></div>
    <div class="loading" id="loading"></div>
  </div>

<script>
// --- CONFIGURATION ---
const CHANNELS = [
  // CH 1: Toggle (Direct vs Fallback)
  { name: "1. ਪਟਨਾ ਸਾਹਿਬ ਲਾਈਵ", channelId: "UC3nqw1kd4AK1q9e68YUoLDQ", fallback: "TTK7eNuI3M0", type: "direct", allowToggle: true },
  
  // CH 2: VIDEO vs RADIO
  { 
    name: "2. ਅੰਮ੍ਰਿਤਸਰ ਸਾਹਿਬ ਲਾਈਵ", 
    channelId: "UCYn6UEtQ771a_OWSiNBoG8w", 
    type: "direct-rss", 
    allowToggle: true,
    isRadioHybrid: true,
    radioUrl: "https://live.sgpc.net:8443/;",
    radioImage: "audioharimandar.png"
  },

  // CH 3: FATEHGARH SAHIB - Toggle/Dual Stream
  { name: "3. ਫਤੇਹਗੜ੍ਹ ਸਾਹਿਬ ਲਾਈਵ", channelId: "UCudVHqnOekwcvpzNpY8_ERw", type: "direct-rss", allowToggle: true },

  // CH 4: BABA DEEP SINGH JI - Direct Stream
  { name: "4. ਬਾਬਾ ਦੀਪ ਸਿੰਘ ਜੀ ਅੰਮ੍ਰਿਤਸਰ ਲਾਈਵ", channelId: "UCxWx-MPft_7mKrFtN6uOaAA", type: "direct" },

  { name: "5. ਆਨੰਦਪੁਰ ਸਾਹਿਬ ਲਾਈਵ", channelId: "UCSx5035_us8h8DOp_YhQDaw", type: "direct" },
  { name: "6. ਦਮਦਮਾ ਸਾਹਿਬ ਲਾਈਵ", channelId: "UCY8jMpyRRcdzSf6uLiU6izQ", type: "direct" },
  { name: "7. ਸੀਸ ਗੰਜ ਸਾਹਿਬ ਦਿੱਲੀ ਲਾਈਵ", channelId: "UCm0p8BmL4d914gBefceFxxA", type: "direct" },
  { name: "8. ਬੰਗਲਾ ਸਾਹਿਬ ਦਿੱਲੀ ਲਾਈਵ", channelId: "UCA1Jqo-WXVuMgs4WcD5f5Yw", type: "auto-rss" },
  { name: "9. ਹਜ਼ੂਰ ਸਾਹਿਬ ਲਾਈਵ", channelId: "UCuerQ47I9Y2qxr4eIopxbYw", type: "direct" },
  
  // CH 0: TIME MODE (Sukhmani Sahib - Local File)
  { name: "0. ਸੁਖਮਨੀ ਸਾਹਿਬ", type: "time", allowToggle: true }
];

// --- GLOBAL VARIABLES ---
const STREAM_DIV = document.getElementById('stream');
const HLS_VIDEO = document.getElementById('hls-video');
const TIME_TV = document.getElementById('time-tv');
const AUDIO_BG = document.getElementById('audio-bg');
const channelNameBox = document.getElementById('channelName');
const loadingIndicator = document.getElementById('loading');
const OVERLAY = document.getElementById('overlay');
const toggleBtn = document.getElementById('toggleBtn');
const BG_AUDIO = document.getElementById('bg-audio');

// LOCAL AUDIO FILE
const SUKHMANI_URL = "sukhmani.mp3";

let currentChannel = parseInt(localStorage.getItem('currentChannel')) || 0;
let streamToggle = 0; 
let activeLoadId = 0; 
let ytPlayer = null;
let hls = null;

// Timers
let refreshTimer, loadTimeout, hideTimeout, safetyTimer, watchdogTimer;
let lastScrollTime = 0;
const SCROLL_SPEED_MS = 350; 

// --- ROBUST FETCH FUNCTION ---
async function fetchLatestVideoId(channelId, offset = 0) {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 5000); 

    try {
        const rssUrl = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent('https://www.youtube.com/feeds/videos.xml?channel_id=' + channelId)}&t=${Date.now()}`;
        const res = await fetch(rssUrl, { signal: controller.signal });
        clearTimeout(timeoutId);
        if (!res.ok) throw new Error("Network response was not ok");
        const data = await res.json();
        const items = data.items || [];
        if (items.length > offset) {
            return items[offset].link.split('v=')[1];
        }
        return null;
    } catch (e) {
        console.warn("Fetch failed or timed out", e);
        return null; 
    }
}

// --- CORE CLEANUP ---
function cleanupEnvironment() {
  if (ytPlayer && typeof ytPlayer.destroy === 'function') {
    try { ytPlayer.stopVideo(); ytPlayer.destroy(); } catch(e){}
  }
  ytPlayer = null;

  if (hls) {
    try { hls.destroy(); } catch(e){}
    hls = null;
  }
  
  // Reset Audio
  BG_AUDIO.pause();
  BG_AUDIO.src = "";
  BG_AUDIO.currentTime = 0; 
  
  AUDIO_BG.style.display = 'none';
  STREAM_DIV.innerHTML = ''; 
  HLS_VIDEO.pause(); 
  HLS_VIDEO.src = ""; 
  HLS_VIDEO.style.display = 'none';
  TIME_TV.style.display = 'none';
  
  if (safetyTimer) clearTimeout(safetyTimer);
  if (watchdogTimer) clearTimeout(watchdogTimer);
}

// --- SPECIAL TOGGLE FOR CH 0 (PAUSE/RESUME) ---
function toggleCh0Audio() {
    if (BG_AUDIO.paused) {
        var playPromise = BG_AUDIO.play();
        if (playPromise !== undefined) {
            playPromise.then(_ => {
                toggleBtn.textContent = 'B';
                toggleBtn.className = 'toggle-B';
                showChannelName("0. ਸੁਖਮਨੀ ਸਾਹਿਬ (Playing)", 1);
            }).catch(error => {
                console.log("Audio Play Failed:", error);
                showChannelName("Error: Audio Blocked", 0);
            });
        }
    } else {
        BG_AUDIO.pause();
        toggleBtn.textContent = 'A';
        toggleBtn.className = 'toggle-A';
        showChannelName("0. ਸੁਖਮਨੀ ਸਾਹਿਬ (Paused)", 0);
    }
}

// --- CHANNEL LOADER ---
function loadChannel(index, toggle = 0) {
  const thisLoadId = activeLoadId;
  localStorage.setItem('currentChannel', index);
  loadingIndicator.style.display = 'block';
  
  cleanupEnvironment(); 

  const channel = CHANNELS[index];
  
  // --- BUTTON LOGIC ---
  if (channel.allowToggle) {
      toggleBtn.style.display = 'flex';
      toggleBtn.textContent = 'A';
      toggleBtn.className = 'toggle-A'; 
  } else {
      toggleBtn.style.display = 'none';
  }

  watchdogTimer = setTimeout(() => {
    if (activeLoadId === thisLoadId && loadingIndicator.style.display !== 'none') {
        loadingIndicator.style.display = 'none';
    }
  }, 8000);

  // --- 1. TIME / SUKHMANI MODE (CH 0) ---
  if (channel.type === 'time') {
    TIME_TV.style.display = 'block'; 
    loadingIndicator.style.display = 'none';
    
    // Load Audio immediately (but paused)
    BG_AUDIO.src = SUKHMANI_URL;
    BG_AUDIO.currentTime = 0; 
    BG_AUDIO.volume = 1.0;
    BG_AUDIO.load();
    
    showChannelName(channel.name, 0);
    return;
  }

  // --- 2. RADIO HYBRID MODE (CH 2) ---
  if (channel.isRadioHybrid && toggle === 1) {
      AUDIO_BG.style.backgroundImage = `url('${channel.radioImage}')`;
      AUDIO_BG.style.display = 'block';
      loadingIndicator.style.display = 'none'; 
      
      BG_AUDIO.src = channel.radioUrl;
      BG_AUDIO.play().catch(e => console.log("Radio play blocked", e));
      
      toggleBtn.textContent = 'B';
      toggleBtn.className = 'toggle-B'; 
      showChannelName(channel.name + " (Audio)", 1);
      return; 
  }
  
  // --- 3. HLS VIDEO ---
  if (channel.type === 'hls') {
    if (activeLoadId !== thisLoadId) return;
    HLS_VIDEO.style.display = 'block';
    if (Hls.isSupported()) {
      hls = new Hls(); 
      hls.loadSource(channel.url); 
      hls.attachMedia(HLS_VIDEO);
      hls.on(Hls.Events.MANIFEST_PARSED, () => { 
        HLS_VIDEO.play().catch(e => console.log("Autoplay blocked", e));
        loadingIndicator.style.display = 'none'; 
      });
    }
    showChannelName(channel.name, 0);
    return;
  }

  // --- 4. YOUTUBE VIDEO SETUP ---
  STREAM_DIV.style.display = 'block';
  const playerDivId = `yt-player-${Date.now()}`;
  STREAM_DIV.innerHTML = `<div id="${playerDivId}" class="video-placeholder"></div>`;

  const processYoutubeLoad = (videoIdOrParams) => {
      if (activeLoadId !== thisLoadId) return;
      initYoutubeApiPlayer(playerDivId, videoIdOrParams, channel, thisLoadId);
  };

  if (channel.type === 'direct-rss') {
      if (toggle === 1) {
          showChannelName(channel.name, 1);
          toggleBtn.textContent = 'B'; toggleBtn.className = 'toggle-B';
          fetchLatestVideoId(channel.channelId, 1).then(vidId => {
              if (vidId) processYoutubeLoad({ type: 'video_id', id: vidId });
              else processYoutubeLoad({ type: 'channel_live', id: channel.channelId });
          });
      } else {
          showChannelName(channel.name, 0);
          processYoutubeLoad({ type: 'channel_live', id: channel.channelId });
      }
      return;
  }

  // Standard Logic
  if (channel.type === 'hybrid' || channel.type === 'auto-rss') {
      const isAlt = (toggle === 1 && channel.type === 'hybrid');
      showChannelName(channel.name, isAlt ? 1 : 0);
      fetchLatestVideoId(channel.channelId, isAlt ? 1 : 0).then(vidId => {
          let target = vidId || channel.channelId; 
          if (!vidId) processYoutubeLoad({ type: 'channel_live', id: channel.channelId });
          else processYoutubeLoad({ type: 'video_id', id: vidId });
      });
  } else if (channel.type === 'direct') {
      if (toggle === 1 && channel.fallback) {
          showChannelName(channel.name, 1);
          toggleBtn.textContent = 'B'; toggleBtn.className = 'toggle-B';
          processYoutubeLoad({ type: 'video_id', id: channel.fallback });
      } else {
          showChannelName(channel.name, 0);
          processYoutubeLoad({ type: 'channel_live', id: channel.channelId });
      }
  }

  setupAutoRefresh();
}

// --- ROBUST YOUTUBE API PLAYER ---
function initYoutubeApiPlayer(divId, videoData, channelObj, loadId) {
    if (loadId !== activeLoadId) return;

    if (!window.YT || !window.YT.Player) {
        setTimeout(() => initYoutubeApiPlayer(divId, videoData, channelObj, loadId), 100);
        return;
    }

    if (videoData.type === 'channel_live') {
       const embedUrl = `https://www.youtube.com/embed/live_stream?channel=${videoData.id}&autoplay=1&mute=1&controls=0&enablejsapi=1&origin=${window.location.origin}`;
       const iframe = document.createElement('iframe');
       iframe.id = divId; 
       iframe.src = embedUrl; 
       iframe.style.width = "100%"; 
       iframe.style.height = "100%"; 
       iframe.style.border = "none"; 
       iframe.allow = "autoplay; fullscreen";
       
       document.getElementById(divId).replaceWith(iframe);
       
       ytPlayer = new YT.Player(divId, {
           events: { 
               'onReady': onPlayerReady, 
               'onStateChange': onPlayerStateChange, 
               'onError': onPlayerError 
           }
       });
       return;
    }

    ytPlayer = new YT.Player(divId, {
        height: '100%', 
        width: '100%', 
        videoId: videoData.id,
        playerVars: { 
            'autoplay': 1, 
            'mute': 1, 
            'controls': 0, 
            'rel': 0, 
            'modestbranding': 1, 
            'iv_load_policy': 3, 
            'fs': 0 
        },
        events: { 
            'onReady': onPlayerReady, 
            'onStateChange': onPlayerStateChange, 
            'onError': onPlayerError 
        }
    });

    function onPlayerReady(event) {
        if (loadId !== activeLoadId) return;
        loadingIndicator.style.display = 'none';
        event.target.playVideo();
        setTimeout(() => { try { event.target.unMute(); } catch(e){} }, 500);
        setTimeout(() => { try { event.target.unMute(); } catch(e){} }, 2000);
    }

    function onPlayerStateChange(event) {
        if (loadId !== activeLoadId) return;
        
        if (event.data === YT.PlayerState.ENDED) {
             if (channelObj.fallback) {
                 initYoutubeApiPlayer(divId, {type: 'video_id', id: channelObj.fallback}, channelObj, loadId);
             }
        }
    }

    function onPlayerError(event) {
        if (loadId !== activeLoadId) return;
        console.log("YT Error:", event.data);
        
        if (channelObj.type === 'direct-rss' && videoData.type === 'channel_live') {
            loadingIndicator.style.display = 'block';
            fetchLatestVideoId(channelObj.channelId, 0).then(vidId => {
                 if (loadId === activeLoadId && vidId) {
                     cleanupEnvironment();
                     STREAM_DIV.style.display = 'block';
                     const newDivId = `yt-fb-${Date.now()}`;
                     STREAM_DIV.innerHTML = `<div id="${newDivId}" class="video-placeholder"></div>`;
                     initYoutubeApiPlayer(newDivId, {type: 'video_id', id: vidId}, channelObj, loadId);
                 } else if (loadId === activeLoadId) {
                     loadingIndicator.style.display = 'none';
                 }
            });
            return;
        }

        if (channelObj.fallback && videoData.id !== channelObj.fallback) {
             cleanupEnvironment(); 
             STREAM_DIV.style.display = 'block';
             STREAM_DIV.innerHTML = `<div id="${divId}" class="video-placeholder"></div>`;
             initYoutubeApiPlayer(divId, {type: 'video_id', id: channelObj.fallback}, channelObj, loadId);
        } else {
            loadingIndicator.style.display = 'none'; 
        }
    }
}

function setupAutoRefresh() {
  clearTimeout(refreshTimer);
  refreshTimer = setTimeout(() => { window.location.reload(); }, 10800000); // 3 Hours
}

function showChannelName(name, styleType) {
  channelNameBox.textContent = name;
  channelNameBox.className = (styleType === 1) ? 'style-alt show' : 'style-main show';
  clearTimeout(hideTimeout);
  hideTimeout = setTimeout(() => channelNameBox.classList.remove("show"), 3000);
}

function queueChannelLoad(index) {
  const isSame = (currentChannel === index);
  const channel = CHANNELS[index];

  // SPECIAL: If Ch 0 is active, just toggle pause/resume (Don't Reload)
  if (isSame && channel.type === 'time') {
      toggleCh0Audio();
      return;
  }
  
  if (isSame && channel.allowToggle) {
      streamToggle = (streamToggle === 0) ? 1 : 0;
  } else {
      streamToggle = 0;
  }
  
  currentChannel = index;
  showChannelName(channel.name, streamToggle);
  
  if (loadTimeout) clearTimeout(loadTimeout);
  activeLoadId++; 
  const thisId = activeLoadId;

  loadTimeout = setTimeout(() => { 
      if (thisId === activeLoadId) {
          loadChannel(index, streamToggle); 
      }
  }, SCROLL_SPEED_MS); 
}

// --- INPUT HANDLING ---
let cursorTimeout;
window.addEventListener('mousemove', () => {
    document.body.classList.add('user-active');
    clearTimeout(cursorTimeout);
    cursorTimeout = setTimeout(() => {
        document.body.classList.remove('user-active');
    }, 3000);
});

// Toggle Button Click
toggleBtn.addEventListener('click', (e) => {
    e.stopPropagation(); 
    queueChannelLoad(currentChannel);
});

window.addEventListener('keydown', (e) => {
  const k = e.key; const c = e.keyCode; const now = Date.now();
  if (now - lastScrollTime < 200) return; 
  lastScrollTime = now;

  if (k === "ArrowRight" || k === "ArrowUp" || k === "ChannelUp" || c === 427 || k === "PageUp" || c === 33) {
    e.preventDefault(); queueChannelLoad((currentChannel + 1) % CHANNELS.length);
  } else if (k === "ArrowLeft" || k === "ArrowDown" || k === "ChannelDown" || c === 428 || k === "PageDown" || c === 34) {
    e.preventDefault(); queueChannelLoad((currentChannel - 1 + CHANNELS.length) % CHANNELS.length);
  } else if (/^[1-9]$/.test(k)) {
    e.preventDefault(); queueChannelLoad(parseInt(k, 10) - 1);
  } else if (k === "0") {
    e.preventDefault(); queueChannelLoad(9);
  }
});
OVERLAY.addEventListener('click', () => queueChannelLoad((currentChannel + 1) % CHANNELS.length));

function updateLocalTime() {
  const now = new Date();
  document.querySelector('#time-tv .clock').textContent = now.toLocaleTimeString('en-US', { hour12: true });
  document.querySelector('#time-tv .date').textContent = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
}
setInterval(updateLocalTime, 1000); updateLocalTime();

activeLoadId++;
loadChannel(currentChannel);
</script>
</body>
</html>


