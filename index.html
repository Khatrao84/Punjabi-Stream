<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Gurbani Stream</title>
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="manifest" href="manifest.json">

  <link rel="preconnect" href="https://www.youtube.com">
  <link rel="preconnect" href="https://www.google.com">
  <link rel="preconnect" href="https://api.rss2json.com">
  
  <link rel="icon" href="favicon.png" type="image/png">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Gurmukhi:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://www.youtube.com/iframe_api"></script>

  <style>
    /* --- CORE STYLES --- */
    html, body {
      margin: 0; padding: 0; width: 100%; height: 100%;
      background-color: black; font-family: "Noto Sans Gurmukhi", sans-serif;
      overflow: hidden; -webkit-tap-highlight-color: transparent; 
      user-select: none; cursor: none;
      display: flex; justify-content: center; align-items: center;
    }
    body.user-active { cursor: default; }

    /* --- MAIN UI WRAPPER (Handles Rotation) --- */
    #main-ui {
      position: relative;
      width: 100%; height: 100%;
      display: flex; justify-content: center; align-items: center;
      overflow: hidden;
    }

    /* Portrait Mode: Rotate EVERYTHING 90deg */
    @media screen and (orientation: portrait) {
        #main-ui {
            width: 100vh; height: 100vw;
            transform: rotate(90deg);
        }
    }

    /* --- 16:9 VIDEO BOX --- */
    #app-box {
      position: relative;
      background: black;
      width: 100%; height: 100%;
      max-width: 177.78vh; /* 16/9 Aspect Ratio constraint */
      max-height: 56.25vw; 
      aspect-ratio: 16/9;
      box-shadow: 0 0 20px rgba(0,0,0,0.8);
      z-index: 1; /* Sit below buttons/name if they overlap */
    }

    /* Video Elements */
    #stream, #hls-video, #audio-bg, #time-tv, #overlay, .video-placeholder { 
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
    }
    #stream { z-index: 0; }
    .video-placeholder { background: black; }
    #hls-video { object-fit: cover; z-index: 1; display: none; }
    #audio-bg { background-position: center; background-size: cover; z-index: 1; display: none; }
    #overlay { z-index: 2; cursor: pointer; outline: none; }

    /* --- NAVIGATION BUTTONS (Left/Right Black Bars) --- */
    .nav-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      font-size: 8vh; /* Large Arrows */
      color: rgba(255, 215, 0, 0.4); /* Gold, Transparent */
      padding: 20px;
      cursor: pointer;
      z-index: 20;
      transition: all 0.2s;
      user-select: none;
    }
    .nav-btn:hover, .nav-btn:active {
        color: rgba(255, 215, 0, 1.0);
        transform: translateY(-50%) scale(1.1);
    }
    #btn-prev { left: 1%; }
    #btn-next { right: 1%; }

    /* --- CHANNEL NAME (OUTSIDE 16:9 BOX) --- */
    #channelName {
      position: absolute; 
      bottom: 0; left: 0; width: 100%;
      padding: 15px; 
      font-size: 4vh; font-weight: bold;
      text-align: center; 
      z-index: 30; /* Above everything */
      transform: translateY(100%); opacity: 0;
      transition: transform 0.5s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.5s ease;
      box-sizing: border-box;
      pointer-events: none; /* Let clicks pass through */
    }
    .style-main { 
        background: linear-gradient(to top, rgba(0, 41, 107, 0.9) 0%, rgba(0,0,0,0) 100%);
        color: #FFD700 !important; 
        text-shadow: 2px 2px 4px black;
    }
    .style-alt { 
        background: linear-gradient(to top, rgba(255, 215, 0, 0.9) 0%, rgba(0,0,0,0) 100%);
        color: #00296B !important; 
        text-shadow: none;
    }
    #channelName.show { transform: translateY(0); opacity: 1; }

    /* --- TOGGLE BTN (Inside 16:9 Box) --- */
    #toggleBtn {
      position: absolute; bottom: 5%; left: 3%;
      width: 5vh; height: 5vh; border-radius: 50%; display: none; 
      justify-content: center; align-items: center;
      font-size: 3vh; font-family: Arial, sans-serif; font-weight: bold;
      z-index: 10; cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.6);
      border: 2px solid rgba(255, 255, 255, 0.2);
    }
    .toggle-A { background-color: #00296B; color: #FFD700; }
    .toggle-B { background-color: #FFD700; color: #00296B; }

    /* --- LOADING SPINNER --- */
    .loading {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      width: 10vh; height: 10vh; border: 1vh solid rgba(255, 213, 0, 0.2);
      border-radius: 50%; border-top-color: #ffd500;
      animation: spin 1s linear infinite; z-index: 4; display: none;
    }
    @keyframes spin { to { transform: translate(-50%, -50%) rotate(360deg); } }

    /* --- TIME MODE --- */
    #time-tv {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; z-index: 1; 
      background: url("haarimandr.png") no-repeat center center; background-size: cover; font-family: "Arial Black", sans-serif;
    }
    #time-tv .clock { position: absolute; top: 6%; right: 3%; font-size: 15vh; color: #FFD700; text-shadow: 0 0 10px #FFD700; }
    #time-tv .date { position: absolute; top: 2%; right: 3.5%; font-size: 5vh; color: #FFE066; }

  </style>
</head>
<body>

  <div id="main-ui">
      
      <div id="btn-prev" class="nav-btn">❮</div>

      <div id="app-box">
        <div id="stream"></div>
        <video id="hls-video" playsinline></video>
        <audio id="bg-audio" preload="auto"></audio>
        <div id="audio-bg"></div>
        <div id="time-tv"><div class="clock"></div><div class="date"></div></div>
        
        <div id="toggleBtn" class="toggle-A">A</div>
        <div id="overlay" tabindex="0"></div>
        <div class="loading" id="loading"></div>
      </div>

      <div id="btn-next" class="nav-btn">❯</div>

      <div id="channelName" class="style-main"></div>

  </div>

<script>
const Config = {
  SCROLL_SPEED_MS: 350,
  AUTO_REFRESH_MS: 10800000, 
  LOAD_TIMEOUT_MS: 8000,
  RSS_FETCH_TIMEOUT: 5000,
  KEY_THROTTLE_MS: 400,
  LOCAL_AUDIO_FILE: "sukhmani.mp3",
  LOCAL_RADIO_IMG: "audioharimandar.png"
};

const CHANNELS = [
  { name: "1. ਸ਼੍ਰੀ ਪਟਨਾ ਸਾਹਿਬ ਲਾਈਵ", channelId: "UC3nqw1kd4AK1q9e68YUoLDQ", fallback: "TTK7eNuI3M0", type: "direct", allowToggle: true },
  { name: "2. ਸ਼੍ਰੀ ਅੰਮ੍ਰਿਤਸਰ ਸਾਹਿਬ ਲਾਈਵ", channelId: "UCYn6UEtQ771a_OWSiNBoG8w", type: "direct-rss", allowToggle: true, isRadioHybrid: true, radioUrl: "https://live.sgpc.net:8443/;", radioImage: Config.LOCAL_RADIO_IMG },
  { name: "3. ਸ਼੍ਰੀ ਫਤੇਹਗੜ੍ਹ ਸਾਹਿਬ ਲਾਈਵ", channelId: "UCudVHqnOekwcvpzNpY8_ERw", type: "direct-rss", allowToggle: true },
  { name: "4. ਸ਼੍ਰੀ ਕੋਤਵਾਲੀ ਸਾਹਿਬ ਮੋਰਿੰਡਾ ਲਾਈਵ", channelId: "UCri5TwOgoDY3ywUDK9Ar1Lg", type: "direct" },
  { name: "5. ਸ਼੍ਰੀ ਆਨੰਦਪੁਰ ਸਾਹਿਬ ਲਾਈਵ", channelId: "UCSx5035_us8h8DOp_YhQDaw", type: "direct" },
  { name: "6. ਸ਼੍ਰੀ ਦਮਦਮਾ ਸਾਹਿਬ ਲਾਈਵ", channelId: "UCY8jMpyRRcdzSf6uLiU6izQ", type: "direct" },
  { name: "7. ਸ਼੍ਰੀ ਦੂਖ-ਨਿਵਾਰਨ ਸਾਹਿਬ ਲੁਧਿਆਣਾ ਲਾਈਵ", channelId: "UCPKPN4bzM8Ja-F_kIEZoAhA", type: "direct-rss" },
  { name: "8. ਸ਼੍ਰੀ ਦੂਖ-ਨਿਵਾਰਨ ਸਾਹਿਬ ਪਟਿਆਲਾੀ ਲਾਈਵ", channelId: "UC7Uf4ZOlCGM3zBCLqcNPtJg", type: "direct-rss" },
  { name: "9. ਸ਼੍ਰੀ ਬਾਬਾ ਦੀਪ ਸਿੰਘ ਜੀ ਅੰਮ੍ਰਿਤਸਰ ਲਾਈਵ", channelId: "UCxWx-MPft_7mKrFtN6uOaAA", type: "direct" },
  { name: "10. ਸ਼੍ਰੀ ਪੰਜੋਖਰਾ ਸਾਹਿਬ ਅੰਬਾਲਾ ਲਾਈਵ", channelId: "UCWd5TUzbLUe6_TWKW9vaDmQ", type: "direct" },
  { name: "11. ਸ਼੍ਰੀ ਬੰਗਲਾ ਸਾਹਿਬ ਦਿੱਲੀ ਲਾਈਵ", channelId: "UCA1Jqo-WXVuMgs4WcD5f5Yw", type: "auto-rss" },
  { name: "12. ਸ਼੍ਰੀ ਸੀਸ ਗੰਜ ਸਾਹਿਬ ਦਿੱਲੀ ਲਾਈਵ", channelId: "UCm0p8BmL4d914gBefceFxxA", type: "direct" },
  { name: "13. ਸ਼੍ਰੀ ਸਿੰਘ ਸ਼ਹੀਦਾਂ ਸਾਹਿਬ ਸੋਹਾਣਾ ਲਾਈਵ", channelId: "UCflFRcHHT8Ab7AvjvIVcrQA", type: "direct" },
  { name: "14. ਸ਼੍ਰੀ ਹਜ਼ੂਰ ਸਾਹਿਬ ਲਾਈਵ", channelId: "UCuerQ47I9Y2qxr4eIopxbYw", type: "direct" },
  { name: "0. ਸੁਖਮਨੀ ਸਾਹਿਬ", type: "time", allowToggle: true }
];

const AppState = {
  currentChannel: parseInt(localStorage.getItem('currentChannel')) || 0,
  streamToggle: 0,
  activeLoadId: 0, 
  lastScrollTime: 0, 
  timers: { load: null, banner: null, watchdog: null, refresh: null },
  wakeLock: null
};

const UI = {
  stream: document.getElementById('stream'),
  hlsVideo: document.getElementById('hls-video'),
  timeTv: document.getElementById('time-tv'),
  audioBg: document.getElementById('audio-bg'),
  channelName: document.getElementById('channelName'),
  loading: document.getElementById('loading'),
  overlay: document.getElementById('overlay'),
  toggleBtn: document.getElementById('toggleBtn'),
  bgAudio: document.getElementById('bg-audio'),
  clock: document.querySelector('#time-tv .clock'),
  date: document.querySelector('#time-tv .date'),
  btnPrev: document.getElementById('btn-prev'),
  btnNext: document.getElementById('btn-next')
};

const PlayerService = {
  ytPlayer: null, hls: null,
  cleanup() {
    if (this.ytPlayer) {
      if(typeof this.ytPlayer.stopVideo === 'function') try { this.ytPlayer.stopVideo(); } catch(e){}
      if(typeof this.ytPlayer.destroy === 'function') try { this.ytPlayer.destroy(); } catch(e){}
    }
    this.ytPlayer = null;
    if (this.hls) { try { this.hls.destroy(); } catch(e){} this.hls = null; }
    UI.bgAudio.pause(); UI.bgAudio.src = ""; UI.bgAudio.currentTime = 0; 
    UI.audioBg.style.display = 'none'; UI.timeTv.style.display = 'none';
    UI.stream.innerHTML = ''; UI.hlsVideo.pause(); UI.hlsVideo.src = ""; UI.hlsVideo.style.display = 'none';
    clearTimeout(AppState.timers.watchdog);
  },
  initYouTube(divId, videoData, channelObj, loadId) {
    if (loadId !== AppState.activeLoadId) return;
    if (!window.YT || !window.YT.Player) { setTimeout(() => this.initYouTube(divId, videoData, channelObj, loadId), 100); return; }
    const playerOpts = {
         height: '100%', width: '100%', 
         playerVars: { 'autoplay': 1, 'mute': 1, 'controls': 0, 'rel': 0, 'modestbranding': 1, 'iv_load_policy': 3, 'fs': 0 },
         events: { 'onReady': (e) => this.onPlayerReady(e, loadId), 'onStateChange': (e) => this.onStateChange(e, channelObj, loadId), 'onError': (e) => this.onError(e, videoData, channelObj, loadId, divId) }
    };
    if (videoData.type === 'channel_live') {
       const embedUrl = `https://www.youtube.com/embed/live_stream?channel=${videoData.id}&autoplay=1&mute=1&controls=0&enablejsapi=1&origin=${window.location.origin}`;
       const iframe = document.createElement('iframe');
       iframe.id = divId; iframe.src = embedUrl; iframe.style.width = "100%"; iframe.style.height = "100%"; iframe.style.border = "none"; iframe.allow = "autoplay; fullscreen";
       document.getElementById(divId).replaceWith(iframe);
       this.ytPlayer = new YT.Player(divId, { events: playerOpts.events });
    } else {
       playerOpts.videoId = videoData.id;
       this.ytPlayer = new YT.Player(divId, playerOpts);
    }
  },
  onPlayerReady(event, loadId) {
    if (loadId !== AppState.activeLoadId) return;
    UI.loading.style.display = 'none'; event.target.playVideo();
    setTimeout(() => { try { event.target.unMute(); } catch(e){} }, 500); setTimeout(() => { try { event.target.unMute(); } catch(e){} }, 2000);
  },
  onStateChange(event, channelObj, loadId) {
    if (loadId !== AppState.activeLoadId) return;
    if (event.data === YT.PlayerState.ENDED && channelObj.fallback) {
         UI.stream.innerHTML = ''; 
         const newDivId = `yt-fb-${Date.now()}`;
         UI.stream.innerHTML = `<div id="${newDivId}" class="video-placeholder"></div>`;
         this.initYouTube(newDivId, {type: 'video_id', id: channelObj.fallback}, channelObj, loadId);
    }
  },
  onError(event, videoData, channelObj, loadId, divId) {
    if (loadId !== AppState.activeLoadId) return;
    if (channelObj.type === 'direct-rss' && videoData.type === 'channel_live') {
        UI.loading.style.display = 'block';
        DataService.fetchRSS(channelObj.channelId).then(vidId => {
             if (loadId === AppState.activeLoadId && vidId) {
                 this.cleanup(); UI.stream.style.display = 'block';
                 const newDivId = `yt-rss-${Date.now()}`;
                 UI.stream.innerHTML = `<div id="${newDivId}" class="video-placeholder"></div>`;
                 this.initYouTube(newDivId, {type: 'video_id', id: vidId}, channelObj, loadId);
             } else { UI.loading.style.display = 'none'; }
        });
        return;
    }
    if (channelObj.fallback && videoData.id !== channelObj.fallback) {
         this.cleanup(); UI.stream.style.display = 'block';
         const newDivId = `yt-fb-${Date.now()}`;
         UI.stream.innerHTML = `<div id="${newDivId}" class="video-placeholder"></div>`;
         this.initYouTube(newDivId, {type: 'video_id', id: channelObj.fallback}, channelObj, loadId);
    } else { UI.loading.style.display = 'none'; }
  }
};

const DataService = {
  async fetchRSS(channelId, offset = 0) {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), Config.RSS_FETCH_TIMEOUT);
    try {
      const url = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent('https://www.youtube.com/feeds/videos.xml?channel_id=' + channelId)}&t=${Date.now()}`;
      const res = await fetch(url, { signal: controller.signal });
      clearTimeout(timeout);
      if (!res.ok) throw new Error("RSS Error");
      const data = await res.json();
      if (data.items && data.items.length > offset) return data.items[offset].link.split('v=')[1];
      return null;
    } catch (e) { return null; }
  }
};

const App = {
  init() {
    AppState.activeLoadId++;
    this.loadChannel(AppState.currentChannel, 0);
    this.setupInputs();
    this.setupClock();
    this.requestWakeLock(); 
    
    // --- ANDROID PWA LOCK ---
    if (screen.orientation && screen.orientation.lock) {
        screen.orientation.lock('landscape').catch(()=>{});
    }

    AppState.timers.refresh = setTimeout(() => window.location.reload(), Config.AUTO_REFRESH_MS);
  },

  async requestWakeLock() {
    if ('wakeLock' in navigator) {
      try {
        AppState.wakeLock = await navigator.wakeLock.request('screen');
        // Re-request lock when app becomes visible again
        document.addEventListener('visibilitychange', async () => {
          if (AppState.wakeLock !== null && document.visibilityState === 'visible') {
            AppState.wakeLock = await navigator.wakeLock.request('screen');
          }
        });
      } catch (err) { }
    }
  },

  updateMediaSession(name) {
    // BACKGROUND AUDIO SUPPORT: Metadata & Handlers
    if ('mediaSession' in navigator) {
      navigator.mediaSession.metadata = new MediaMetadata({ 
          title: name, 
          artist: "Gurbani Stream", 
          artwork: [{ src: 'favicon.png', sizes: '96x96', type: 'image/png' }] 
      });
      
      // Handlers keep the session alive in background
      navigator.mediaSession.setActionHandler('previoustrack', () => this.changeChannel(-1));
      navigator.mediaSession.setActionHandler('nexttrack', () => this.changeChannel(1));
      navigator.mediaSession.setActionHandler('play', () => { if(AppState.currentChannel===0) this.toggleCh0Audio(); });
      navigator.mediaSession.setActionHandler('pause', () => { if(AppState.currentChannel===0) this.toggleCh0Audio(); });
    }
  },

  setupClock() {
    const update = () => {
      const now = new Date();
      UI.clock.textContent = now.toLocaleTimeString('en-US', { hour12: true });
      UI.date.textContent = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    };
    setInterval(update, 1000); update();
  },

  setupInputs() {
    let cursorTimeout;
    const wakeUI = () => {
        document.body.classList.add('user-active');
        clearTimeout(cursorTimeout);
        cursorTimeout = setTimeout(() => document.body.classList.remove('user-active'), 3000);
    };
    window.addEventListener('mousemove', wakeUI); window.addEventListener('click', wakeUI);

    UI.toggleBtn.addEventListener('click', (e) => { e.stopPropagation(); this.triggerChannelLoad(AppState.currentChannel); });
    
    // --- CONDITIONALLY ENABLE OVERLAY CLICK ---
    // If it's a touch device (Android), DO NOT add click listener to overlay.
    // If it's PC or TV (No touch), ADD the listener.
    const isTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
    if (!isTouch) {
        UI.overlay.addEventListener('click', () => this.changeChannel(1));
    }
    
    // --- NAV BUTTONS ---
    UI.btnPrev.addEventListener('click', (e) => { e.stopPropagation(); this.changeChannel(-1); wakeUI(); });
    UI.btnNext.addEventListener('click', (e) => { e.stopPropagation(); this.changeChannel(1); wakeUI(); });

    let keyBuffer = "";
    let bufferTimer = null;

    window.addEventListener('keydown', (e) => {
      const k = e.key; const c = e.keyCode; const now = Date.now();
      if (!/^[0-9]$/.test(k)) {
          if (now - AppState.lastScrollTime < Config.KEY_THROTTLE_MS) return; 
          AppState.lastScrollTime = now;
      }
      wakeUI();

      if (k === "ArrowRight" || k === "ArrowUp" || k === "ChannelUp" || c === 427 || k === "PageUp" || c === 33) {
        e.preventDefault(); this.changeChannel(1);
      } else if (k === "ArrowLeft" || k === "ArrowDown" || k === "ChannelDown" || c === 428 || k === "PageDown" || c === 34) {
        e.preventDefault(); this.changeChannel(-1);
      } 
      else if (/^[0-9]$/.test(k)) {
        e.preventDefault();
        keyBuffer += k;
        clearTimeout(bufferTimer);
        bufferTimer = setTimeout(() => {
            const num = parseInt(keyBuffer, 10);
            keyBuffer = "";
            let targetIndex = -1;
            if (num === 0) targetIndex = CHANNELS.findIndex(ch => ch.name.startsWith("0."));
            else targetIndex = CHANNELS.findIndex(ch => ch.name.startsWith(num + "."));
            if (targetIndex !== -1) this.triggerChannelLoad(targetIndex);
        }, 1200); 
      }
    });
  },

  changeChannel(dir) {
    const newIdx = (AppState.currentChannel + dir + CHANNELS.length) % CHANNELS.length;
    this.triggerChannelLoad(newIdx);
  },

  triggerChannelLoad(index) {
    const isSame = (AppState.currentChannel === index);
    const channel = CHANNELS[index];
    if (isSame && channel.type === 'time') { this.toggleCh0Audio(); return; }
    if (isSame && channel.allowToggle) AppState.streamToggle = (AppState.streamToggle === 0) ? 1 : 0;
    else AppState.streamToggle = 0;

    AppState.currentChannel = index;
    this.showBanner(channel.name, AppState.streamToggle);
    this.updateMediaSession(channel.name);
    
    clearTimeout(AppState.timers.load);
    AppState.activeLoadId++; const thisId = AppState.activeLoadId;
    AppState.timers.load = setTimeout(() => { if (thisId === AppState.activeLoadId) this.loadChannel(index, AppState.streamToggle); }, Config.SCROLL_SPEED_MS);
  },

  toggleCh0Audio() {
    if (UI.bgAudio.paused) {
        UI.bgAudio.play().then(() => {
             UI.toggleBtn.textContent = 'B'; UI.toggleBtn.className = 'toggle-B';
             this.showBanner("0. ਸੁਖਮਨੀ ਸਾਹਿਬ (Playing)", 1);
        }).catch(() => this.showBanner("Error: Audio Blocked", 0));
    } else {
        UI.bgAudio.pause(); UI.toggleBtn.textContent = 'A'; UI.toggleBtn.className = 'toggle-A';
        this.showBanner("0. ਸੁਖਮਨੀ ਸਾਹਿਬ (Paused)", 0);
    }
  },

  showBanner(name, mode) {
    UI.channelName.textContent = name;
    UI.channelName.className = (mode === 1) ? 'style-alt show' : 'style-main show';
    clearTimeout(AppState.timers.banner);
    AppState.timers.banner = setTimeout(() => UI.channelName.classList.remove("show"), 3000);
  },

  loadChannel(index, toggle) {
    const channel = CHANNELS[index];
    const genId = AppState.activeLoadId;
    localStorage.setItem('currentChannel', index);
    
    UI.loading.style.display = 'block';
    PlayerService.cleanup(); 
    AppState.timers.watchdog = setTimeout(() => { if (genId === AppState.activeLoadId) UI.loading.style.display = 'none'; }, Config.LOAD_TIMEOUT_MS);

    if (channel.allowToggle) { UI.toggleBtn.style.display = 'flex'; UI.toggleBtn.textContent = (toggle === 0) ? 'A' : 'B'; UI.toggleBtn.className = (toggle === 0) ? 'toggle-A' : 'toggle-B'; } 
    else { UI.toggleBtn.style.display = 'none'; }

    if (channel.type === 'time') {
      UI.timeTv.style.display = 'block'; UI.loading.style.display = 'none';
      UI.bgAudio.src = Config.LOCAL_AUDIO_FILE; UI.bgAudio.currentTime = 0; UI.bgAudio.volume = 1.0; UI.bgAudio.load(); 
      this.showBanner(channel.name, 0); return;
    }

    if (channel.isRadioHybrid && toggle === 1) {
      UI.audioBg.style.backgroundImage = `url('${channel.radioImage}')`; UI.audioBg.style.display = 'block'; UI.loading.style.display = 'none';
      UI.bgAudio.src = channel.radioUrl; UI.bgAudio.play().catch(e => console.warn(e));
      this.showBanner(channel.name + " (Audio)", 1); return;
    }

    const divId = `yt-player-${Date.now()}`;
    UI.stream.innerHTML = `<div id="${divId}" class="video-placeholder"></div>`;
    UI.stream.style.display = 'block';

    if (channel.type === 'direct-rss') {
        if (toggle === 1) {
            this.showBanner(channel.name, 1);
            DataService.fetchRSS(channel.channelId, 1).then(vidId => {
                 if (genId !== AppState.activeLoadId) return;
                 if (vidId) PlayerService.initYouTube(divId, {type: 'video_id', id: vidId}, channel, genId);
                 else PlayerService.initYouTube(divId, {type: 'channel_live', id: channel.channelId}, channel, genId);
            });
        } else {
            this.showBanner(channel.name, 0);
            PlayerService.initYouTube(divId, {type: 'channel_live', id: channel.channelId}, channel, genId);
        }
    } 
    else if (channel.type === 'hybrid' || channel.type === 'auto-rss') {
        const isAlt = (toggle === 1 && channel.type === 'hybrid');
        this.showBanner(channel.name, isAlt ? 1 : 0);
        DataService.fetchRSS(channel.channelId, isAlt ? 1 : 0).then(vidId => {
             if (genId !== AppState.activeLoadId) return;
             if (vidId) PlayerService.initYouTube(divId, {type: 'video_id', id: vidId}, channel, genId);
             else PlayerService.initYouTube(divId, {type: 'channel_live', id: channel.channelId}, channel, genId);
        });
    } 
    else if (channel.type === 'direct') {
        if (toggle === 1 && channel.fallback) {
            this.showBanner(channel.name, 1);
            PlayerService.initYouTube(divId, {type: 'video_id', id: channel.fallback}, channel, genId);
        } else {
            this.showBanner(channel.name, 0);
            PlayerService.initYouTube(divId, {type: 'channel_live', id: channel.channelId}, channel, genId);
        }
    }
  }
};
  
App.init(); 
</script>
</body>
</html>
