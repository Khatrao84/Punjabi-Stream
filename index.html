<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Punjabi Stream Pro</title>
  <link rel="icon" href="https://i.postimg.cc/FRDPFKpY/favicon-96x96.png" type="image/png">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Gurmukhi:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://www.youtube.com/iframe_api"></script>

  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      background-color: black; font-family: "Noto Sans Gurmukhi", sans-serif;
      overflow: hidden; -webkit-tap-highlight-color: transparent; user-select: none;
    }
    #container { position: relative; width: 100vw; height: 100vh; }
    #stream { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
    #stream iframe { width: 100%; height: 100%; border: none; display:block; }
    #hls-video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; display: none; }
    #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; cursor: pointer; outline: none; }
    
    #channelName {
      position: absolute; bottom: -100px; left: 0; width: 100%;
      padding: 20px; font-size: 28px; font-weight: bold;
      text-align: center; opacity: 0; transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 5;
    }
    .style-main { background: linear-gradient(0deg, rgba(0,41,107,1) 0%, rgba(0,41,107,0.8) 100%); color: #FFD700; border-top: 3px solid #FFD700; }
    .style-alt { background: linear-gradient(0deg, rgba(255,215,0,1) 0%, rgba(255,215,0,0.8) 100%); color: #00296B; border-top: 3px solid #00296B; }
    
    #channelName.show { bottom: 0; opacity: 1; }
    
    .loading {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      width: 60px; height: 60px; border: 5px solid rgba(255, 215, 0, 0.1);
      border-radius: 50%; border-top-color: #ffd700;
      animation: spin 1s linear infinite; z-index: 10; display: none;
    }
    @keyframes spin { to { transform: translate(-50%, -50%) rotate(360deg); } }

    #live-indicator {
      position: absolute; top: 20px; left: 20px; padding: 5px 12px;
      background: red; color: white; font-size: 14px; font-weight: bold;
      border-radius: 4px; z-index: 6; display: none; text-transform: uppercase;
    }
    
    #time-tv {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      display: none; z-index: 1; background: url("https://i.postimg.cc/053WPD28/haarimandr.png") no-repeat center center;
      background-size: cover;
    }
    #time-tv .clock { position: absolute; top: 6%; right: 3%; font-size: 8.5vw; color: #FFD700; text-shadow: 2px 2px 15px rgba(0,0,0,0.5); font-weight: 900; }
    #time-tv .date { position: absolute; top: 2.5%; right: 3.5%; font-size: 2.8vw; color: #FFE066; font-weight: bold; }
  </style>
</head>
<body>
  <div id="container">
    <div id="stream"></div>
    <video id="hls-video" playsinline></video>
    <div id="time-tv"><div class="clock"></div><div class="date"></div></div>
    <div id="overlay" tabindex="0"></div>
    <div id="channelName" class="style-main"></div>
    <div id="live-indicator">● LIVE</div>
    <div class="loading" id="loading"></div>
  </div>

<script>
const CHANNELS = [
  { name: "1. ਪਟਨਾ ਸਾਹਿਬ ਲਾਈਵ", channelId: "UC3nqw1kd4AK1q9e68YUoLDQ", type: "direct" },
  { name: "2. ਅੰਮ੍ਰਿਤਸਰ ਸਾਹਿਬ ਲਾਈਵ", channelId: "UCYn6UEtQ771a_OWSiNBoG8w", type: "multi-rss" },
  { name: "3. ਬਾਬਾ ਦੀਪ ਸਿੰਘ ਜੀ ਲਾਈਵ", channelId: "UCxWx-MPft_7mKrFtN6uOaAA", type: "direct" },
  { name: "4. ਫਤੇਹਗੜ੍ਹ ਸਾਹਿਬ ਲਾਈਵ", channelId: "UCudVHqnOekwcvpzNpY8_ERw", type: "multi-rss" },
  { name: "5. ਆਨੰਦਪੁਰ ਸਾਹਿਬ ਲਾਈਵ", channelId: "UCSx5035_us8h8DOp_YhQDaw", type: "direct" },
  { name: "6. ਦਮਦਮਾ ਸਾਹਿਬ ਲਾਈਵ", channelId: "UCY8jMpyRRcdzSf6uLiU6izQ", type: "direct" },
  { name: "7. ਹਜ਼ੂਰ ਸਾਹਿਬ ਲਾਈਵ", channelId: "UCuerQ47I9Y2qxr4eIopxbYw", type: "direct" },
  { name: "8. ਚੜਦੀਕਲਾ ਟਾਈਮ ਟੀਵੀ", url: "https://www.yupptv.com/yupptvnew/channels/chardikala-time-tv/live/embed", type: "iframe" },
  { name: "9. ਡੀਡੀ ਪੰਜਾਬੀ", url: "https://d3eyhgoylams0m.cloudfront.net/v1/manifest/93ce20f0f52760bf38be911ff4c91ed02aa2fd92/ed7bd2c7-8d10-4051-b397-2f6b90f99acb/20c8ad14-a158-4a42-8889-e032d070856e/2.m3u8", type: "hls" },
  { name: "0. ਲਾਈਵ ਟਾਈਮ", type: "time" }
];

const STREAM_DIV = document.getElementById('stream');
const HLS_VIDEO = document.getElementById('hls-video');
const TIME_TV = document.getElementById('time-tv');
const channelNameBox = document.getElementById('channelName');
const loadingIndicator = document.getElementById('loading');
const liveIndicator = document.getElementById('live-indicator');
const OVERLAY = document.getElementById('overlay');

let currentChannel = parseInt(localStorage.getItem('currentChannel')) || 0;
let streamToggle = 0; 
let refreshTimer, loadTimeout, hideTimeout, hls;
let lastScrollTime = 0;
const SCROLL_SPEED_MS = 400; 

/**
 * Background Scanner
 */
async function fixLiveMultiStream(channelId) {
    try {
        const proxy = "https://api.allorigins.win/get?url=";
        const target = encodeURIComponent(`https://www.youtube.com/channel/${channelId}/live`);
        const res = await fetch(proxy + target);
        const data = await res.json();
        const idMatch = data.contents.match(/"videoId":"([^"]+)"/);
        const isLive = data.contents.includes('style":"LIVE"');

        if (idMatch && isLive) {
            const bestId = idMatch[1];
            const iframe = STREAM_DIV.querySelector('iframe');
            if (iframe && !iframe.src.includes(bestId)) {
                iframe.src = `https://www.youtube.com/embed/${bestId}?autoplay=1&modestbranding=1&controls=0&rel=0`;
                liveIndicator.style.display = 'block';
            }
        }
    } catch (e) { console.warn("Scanner skipped."); }
}

function loadChannel(index, toggle = 0) {
  localStorage.setItem('currentChannel', index);
  loadingIndicator.style.display = 'block';
  liveIndicator.style.display = 'none';
  STREAM_DIV.style.display = 'none';
  HLS_VIDEO.style.display = 'none';
  TIME_TV.style.display = 'none';
  
  if (hls) { hls.destroy(); hls = null; }
  HLS_VIDEO.pause();
  STREAM_DIV.innerHTML = '';

  const channel = CHANNELS[index];

  if (channel.type === 'multi-rss') {
    STREAM_DIV.style.display = 'block';
    const rssUrl = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent('https://www.youtube.com/feeds/videos.xml?channel_id=' + channel.channelId)}&t=${Date.now()}`;
    
    fetch(rssUrl).then(res => res.json()).then(data => {
        let items = data.items || [];
        // Only allow toggle for Channel 4 (Index 3)
        let vidId = (index === 3 && toggle === 1 && items.length >= 2) ? items[1].link.split('v=')[1] : (items[0] ? items[0].link.split('v=')[1] : null);
        
        const finalUrl = vidId ? `https://www.youtube.com/embed/${vidId}?autoplay=1&modestbranding=1&controls=0&rel=0` : `https://www.youtube.com/embed/live_stream?channel=${channel.channelId}&autoplay=1&modestbranding=1&controls=0`;
        
        STREAM_DIV.innerHTML = `<iframe src="${finalUrl}" allow="autoplay; fullscreen"></iframe>`;
        STREAM_DIV.querySelector('iframe').onload = () => {
            loadingIndicator.style.display = 'none';
            fixLiveMultiStream(channel.channelId);
        };
        showChannelName(channel.name, (index === 3 ? toggle : 0));
    });

  } else if (channel.type === 'direct') {
    STREAM_DIV.style.display = 'block';
    STREAM_DIV.innerHTML = `<iframe src="https://www.youtube.com/embed/live_stream?channel=${channel.channelId}&autoplay=1&modestbranding=1&controls=0" allow="autoplay; fullscreen"></iframe>`;
    STREAM_DIV.querySelector('iframe').onload = () => loadingIndicator.style.display = 'none';
    showChannelName(channel.name, 0);

  } else if (channel.type === 'hls') {
    HLS_VIDEO.style.display = 'block';
    if (Hls.isSupported()) {
      hls = new Hls({ recoverDecodingError: true }); 
      hls.loadSource(channel.url); hls.attachMedia(HLS_VIDEO);
      hls.on(Hls.Events.MANIFEST_PARSED, () => { HLS_VIDEO.play(); loadingIndicator.style.display = 'none'; });
    }
    showChannelName(channel.name, 0);

  } else if (channel.type === 'iframe') {
    STREAM_DIV.style.display = 'block';
    STREAM_DIV.innerHTML = `<iframe src="${channel.url}" allow="autoplay; fullscreen"></iframe>`;
    STREAM_DIV.querySelector('iframe').onload = () => loadingIndicator.style.display = 'none';
    showChannelName(channel.name, 0);

  } else if (channel.type === 'time') {
    TIME_TV.style.display = 'block'; 
    loadingIndicator.style.display = 'none';
    showChannelName(channel.name, 0);
  }
}

function showChannelName(name, styleType) {
  channelNameBox.textContent = name;
  channelNameBox.className = (styleType === 1) ? 'style-alt show' : 'style-main show';
  clearTimeout(hideTimeout);
  hideTimeout = setTimeout(() => channelNameBox.classList.remove("show"), 3500);
}

function queueChannelLoad(index) {
  const isSame = (currentChannel === index);
  
  // LOGIC CHANGE: Only toggle if index is 3 (Channel 4)
  if (isSame && index === 3) {
    streamToggle = (streamToggle === 0) ? 1 : 0;
  } else {
    streamToggle = 0;
  }
  
  currentChannel = index;
  showChannelName(CHANNELS[index].name, streamToggle);
  
  if (loadTimeout) clearTimeout(loadTimeout);
  loadTimeout = setTimeout(() => { loadChannel(index, streamToggle); }, 500);
}

window.addEventListener('keydown', (e) => {
  const k = e.key; const now = Date.now();
  if (now - lastScrollTime < SCROLL_SPEED_MS) return;
  lastScrollTime = now;
  
  if (["ArrowRight", "ArrowUp", "PageUp", "ChannelUp"].includes(k)) {
    queueChannelLoad((currentChannel + 1) % CHANNELS.length);
  } else if (["ArrowLeft", "ArrowDown", "PageDown", "ChannelDown"].includes(k)) {
    queueChannelLoad((currentChannel - 1 + CHANNELS.length) % CHANNELS.length);
  } else if (/^[0-9]$/.test(k)) {
    const target = k === "0" ? 9 : parseInt(k) - 1;
    queueChannelLoad(target);
  }
});

OVERLAY.addEventListener('click', () => queueChannelLoad((currentChannel + 1) % CHANNELS.length));

function updateLocalTime() {
  const now = new Date();
  document.querySelector('.clock').textContent = now.toLocaleTimeString('en-US', { hour12: true, hour: '2-digit', minute: '2-digit', second: '2-digit' });
  document.querySelector('.date').textContent = now.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
}

setInterval(updateLocalTime, 1000); 
updateLocalTime();
loadChannel(currentChannel);
</script>
</body>
</html>
